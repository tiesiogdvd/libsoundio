name: Build libsoundio Static Libraries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: andrewrk/libsoundio
        ref: master
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libasound2-dev libpulse-dev libjack-jackd2-dev
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)
        ls -la *.a
        cp libsoundio_static.a libsoundio-linux-x64.a
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-linux-x64
        path: build/libsoundio-linux-x64.a

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: andrewrk/libsoundio
        ref: master
    
    - name: Install dependencies
      run: |
        brew install cmake
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake ..
        make -j$(sysctl -n hw.ncpu)
        ls -la *.a
        cp libsoundio_static.a libsoundio-macos-x64.a
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-macos-x64
        path: build/libsoundio-macos-x64.a

  build-windows:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v4
      with:
        repository: andrewrk/libsoundio
        ref: master
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Build
      shell: cmd
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64
        msbuild libsoundio.sln /p:Configuration=Debug /p:Platform=x64
        dir *.lib
        copy Debug\soundio_static.lib libsoundio-windows-x64.a
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-windows-x64
        path: build/libsoundio-windows-x64.a

  test-usage:
    needs: [build-windows]
    runs-on: windows-2022
    steps:
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: libsoundio-windows-x64
        path: test/
    
    - name: Test compilation
      shell: cmd
      run: |
        echo #define SOUNDIO_STATIC_LIBRARY > test.c
        echo #include ^<stdio.h^> >> test.c
        echo int main() { printf("Test OK\n"); return 0; } >> test.c
        
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl test.c
        test.exe

  package-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create release package
      run: |
        mkdir release
        find artifacts -name "*.a" -exec cp {} release/ \;
        ls -la release/
        
        # Create usage instructions
        cat > release/README.md << 'EOF'
        # libsoundio Static Libraries
        
        ## Usage
        
        ### Windows
        - File: `libsoundio-windows-x64.a`
        - Define: `#define SOUNDIO_STATIC_LIBRARY`
        - Link: `libsoundio-windows-x64.a ole32.lib`
        
        ### Linux
        - File: `libsoundio-linux-x64.a`  
        - Link: `libsoundio-linux-x64.a -lpthread -lasound -lpulse -ljack`
        
        ### macOS
        - File: `libsoundio-macos-x64.a`
        - Link: `libsoundio-macos-x64.a -framework CoreAudio -framework AudioUnit -framework CoreFoundation`
        
        Get soundio.h from: https://raw.githubusercontent.com/andrewrk/libsoundio/master/soundio/soundio.h
        EOF
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-static-all-platforms
        path: release/
