name: Build libsoundio Static Libraries for Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows-static:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            msvc_arch: x64
            msys_env: MINGW64
            msys_prefix: mingw-w64-x86_64
          - arch: x86  
            msvc_arch: Win32
            msys_env: MINGW32
            msys_prefix: mingw-w64-i686
        compiler: [msvc, mingw]
      fail-fast: false

    steps:
    - name: Checkout libsoundio
      uses: actions/checkout@v4
      with:
        repository: andrewrk/libsoundio
        ref: master

    # === MSVC Build ===
    - name: Set up MSVC
      if: matrix.compiler == 'msvc'
      uses: microsoft/setup-msbuild@v1.3

    - name: Patch CMakeLists.txt for MSVC
      if: matrix.compiler == 'msvc'
      run: |
        # Fix CMake version and add C11 support
        $content = Get-Content CMakeLists.txt -Raw
        $content = $content -replace 'cmake_minimum_required\(VERSION 2\.8\.5\)', 'cmake_minimum_required(VERSION 3.10)'
        $content = $content -replace '(project\(libsoundio C\))', "`$1`nset(CMAKE_C_STANDARD 11)`nset(CMAKE_C_STANDARD_REQUIRED ON)"
        Set-Content CMakeLists.txt $content

    - name: Configure CMake (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.msvc_arch }} `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_STATIC_LIBS=ON `
          -DBUILD_DYNAMIC_LIBS=OFF `
          -DBUILD_EXAMPLE_PROGRAMS=OFF `
          -DBUILD_TESTS=OFF `
          -DENABLE_WASAPI=ON `
          -DCMAKE_C_STANDARD=11 `
          -DCMAKE_C_STANDARD_REQUIRED=ON

    - name: Build (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        cd build
        cmake --build . --config Release --target libsoundio_static

    - name: Prepare artifacts (MSVC)
      if: matrix.compiler == 'msvc'
      run: |
        mkdir artifacts
        # Find and copy static library
        Get-ChildItem -Recurse build/ -Name "*soundio_static*.lib" | ForEach-Object {
          copy "build\$_" "artifacts\libsoundio_static_${{ matrix.arch }}_msvc.lib"
        }
        # Copy headers
        mkdir artifacts\include
        copy soundio\*.h artifacts\include\

    # === MinGW Build ===
    - name: Set up MSYS2 for MinGW
      if: matrix.compiler == 'mingw'
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msys_env }}
        update: true
        install: >-
          base-devel
          ${{ matrix.msys_prefix }}-toolchain
          ${{ matrix.msys_prefix }}-cmake
          ${{ matrix.msys_prefix }}-ninja

    - name: Patch CMakeLists.txt for MinGW
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        # Fix CMake version and add C11 support  
        sed -i 's/cmake_minimum_required(VERSION 2\.8\.5)/cmake_minimum_required(VERSION 3.10)/' CMakeLists.txt
        sed -i '/project(libsoundio C)/a set(CMAKE_C_STANDARD 11)\nset(CMAKE_C_STANDARD_REQUIRED ON)' CMakeLists.txt

    - name: Configure CMake (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        mkdir build
        cd build
        cmake .. -G "MSYS Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_STATIC_LIBS=ON \
          -DBUILD_DYNAMIC_LIBS=OFF \
          -DBUILD_EXAMPLE_PROGRAMS=OFF \
          -DBUILD_TESTS=OFF \
          -DENABLE_WASAPI=ON \
          -DCMAKE_C_STANDARD=11 \
          -DCMAKE_C_STANDARD_REQUIRED=ON

    - name: Build (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        cd build
        make libsoundio_static -j$(nproc)

    - name: Prepare artifacts (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        mkdir artifacts
        # Find and copy static library
        find build/ -name "*soundio_static*.a" | head -1 | xargs -I {} cp {} artifacts/libsoundio_static_${{ matrix.arch }}_mingw.a
        # Copy headers
        mkdir artifacts/include
        cp soundio/*.h artifacts/include/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-static-${{ matrix.compiler }}-${{ matrix.arch }}
        path: artifacts/

  combine-artifacts:
    needs: build-windows-static
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts

    - name: Combine artifacts
      run: |
        mkdir -p combined/lib combined/include
        
        # Copy libraries and headers
        find all-artifacts -name "*.lib" -exec cp {} combined/lib/ \; 2>/dev/null || true
        find all-artifacts -name "*.a" -exec cp {} combined/lib/ \; 2>/dev/null || true
        find all-artifacts -name "*.h" -exec cp {} combined/include/ \; 2>/dev/null || true
        
        # Create comprehensive documentation
        cat > combined/README.md << 'EOF'
        # libsoundio Static Libraries for Windows
        
        Static libraries for libsoundio 2.0.0 compiled for Windows with C11 support.
        
        ## Files:
        - `lib/libsoundio_static_x64_msvc.lib` - 64-bit MSVC library
        - `lib/libsoundio_static_x86_msvc.lib` - 32-bit MSVC library  
        - `lib/libsoundio_static_x64_mingw.a` - 64-bit MinGW library
        - `lib/libsoundio_static_x86_mingw.a` - 32-bit MinGW library
        - `include/soundio.h`, `include/endian.h` - Headers
        
        ## Usage Requirements:
        
        ### 1. Define SOUNDIO_STATIC_LIBRARY (MANDATORY)
        ```bash
        # MSVC
        cl /std:c11 /DSOUNDIO_STATIC_LIBRARY your_app.c libsoundio_static_x64_msvc.lib
        
        # MinGW
        gcc -std=c11 -DSOUNDIO_STATIC_LIBRARY your_app.c -L. -lsoundio_static_x64_mingw
        ```
        
        ### 2. CMake Integration:
        ```cmake
        set(CMAKE_C_STANDARD 11)
        set(CMAKE_C_STANDARD_REQUIRED ON)
        
        target_include_directories(your_app PRIVATE path/to/include)
        target_compile_definitions(your_app PRIVATE SOUNDIO_STATIC_LIBRARY)
        
        if(MSVC)
            target_link_libraries(your_app libsoundio_static_x64_msvc.lib)
        else()
            target_link_libraries(your_app libsoundio_static_x64_mingw.a)
        endif()
        ```
        
        ### 3. Dependencies:
        - **None** - Uses Windows WASAPI (built into Windows)
        - Requires C11 compiler support
        
        ## Troubleshooting:
        - **"C atomics require C11"**: Add `/std:c11` (MSVC) or `-std=c11` (GCC)
        - **"undefined symbol __imp_soundio_*"**: Define `SOUNDIO_STATIC_LIBRARY`
        - **Linker errors**: Ensure correct architecture (x86/x64) matches your app
        
        ## Test Example:
        ```c
        #include "soundio.h"
        #include <stdio.h>
        
        int main() {
            struct SoundIo *soundio = soundio_create();
            if (!soundio) return 1;
            
            if (soundio_connect(soundio)) {
                soundio_destroy(soundio);
                return 1;
            }
            
            soundio_flush_events(soundio);
            printf("Success! Devices: %d out, %d in\n", 
                   soundio_output_device_count(soundio),
                   soundio_input_device_count(soundio));
            
            soundio_destroy(soundio);
            return 0;
        }
        ```
        
        Compile test with:
        - MSVC: `cl /std:c11 /DSOUNDIO_STATIC_LIBRARY test.c libsoundio_static_x64_msvc.lib`
        - MinGW: `gcc -std=c11 -DSOUNDIO_STATIC_LIBRARY test.c -L. -lsoundio_static_x64_mingw`
        EOF

    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libsoundio-static-windows-all
        path: combined/
